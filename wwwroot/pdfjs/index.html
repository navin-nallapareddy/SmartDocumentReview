
<!DOCTYPE html>
<html>
<head>
  <title>PDF Highlighter with OCR</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .highlighted { background: yellow; mix-blend-mode: multiply; }
    #viewerContainer { width: 100%; height: 90vh; overflow: auto; border: 1px solid #ccc; margin-top: 1rem; position: relative; }
    canvas { display: block; margin: auto; }
    .ocrText { position: absolute; white-space: pre-wrap; color: transparent; font-weight: bold; }
    .ocrText mark { background: yellow; color: black; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf_viewer.min.css" />
</head>
<body>
  <h2>PDF Keyword Highlighter with OCR</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <input type="text" id="keywords" placeholder="Enter keywords, comma-separated" style="width: 300px;" />
  <button onclick="loadAndHighlight()">Highlight</button>

  <div id="viewerContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script>
    let uploadedFile = null;

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        uploadedFile = URL.createObjectURL(file);
      }
    });

    function highlightOCRText(div, keywords) {
      let content = div.innerText;
      keywords.forEach(keyword => {
        const regex = new RegExp(keyword, 'gi');
        content = content.replace(regex, match => `<mark>${match}</mark>`);
      });
      div.innerHTML = content;
    }

    function loadAndHighlight() {
      if (!uploadedFile) {
        alert("Please upload a PDF first.");
        return;
      }

      const container = document.getElementById('viewerContainer');
      container.innerHTML = '';
      const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(Boolean);

      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

      pdfjsLib.getDocument(uploadedFile).promise.then(pdf => {
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            const scale = 1.5;
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            container.appendChild(canvas);

            page.render({ canvasContext: context, viewport }).promise.then(() => {
              page.getTextContent().then(textContent => {
                if (textContent.items.length > 0) {
                  const textDiv = document.createElement('div');
                  textDiv.className = 'ocrText';
                  textDiv.style.left = '0';
                  textDiv.style.top = canvas.offsetTop + 'px';
                  textDiv.style.width = canvas.width + 'px';
                  textDiv.style.height = canvas.height + 'px';
                  textDiv.style.fontSize = '12px';
                  textDiv.innerText = textContent.items.map(i => i.str).join(' ');
                  highlightOCRText(textDiv, keywords);
                  container.appendChild(textDiv);
                } else {
                  // Run OCR fallback
                  Tesseract.recognize(
                    canvas,
                    'eng',
                    { logger: m => console.log(m) }
                  ).then(({ data: { text } }) => {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'ocrText';
                    textDiv.style.left = '0';
                    textDiv.style.top = canvas.offsetTop + 'px';
                    textDiv.style.width = canvas.width + 'px';
                    textDiv.style.height = canvas.height + 'px';
                    textDiv.style.fontSize = '12px';
                    textDiv.innerText = text;
                    highlightOCRText(textDiv, keywords);
                    container.appendChild(textDiv);
                  });
                }
              });
            });
          });
        }
      });
    }
  </script>
</body>
</html>
