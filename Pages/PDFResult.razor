@page "/results"
@inject NavigationManager Navigation
@inject SmartDocumentReview.Services.ResultStateService ResultStateService
@inject IJSRuntime JS
@using System.Linq
@using System.Text.RegularExpressions
@using SmartDocumentReview.Models

<h3>Matched Results</h3>

<div style="display: flex; height: 90vh;">
    <!-- Left: Match Results -->
    <div style="width: 40%; overflow-y: auto; padding: 1rem;">
        @foreach (var match in ResultStateService.Matches)
        {
            <div style="margin-bottom: 1.5rem;">
                <h4 @onclick="() => LoadPdfAsync(match.PageNumber)"
                    style="cursor: pointer; color: blue; text-decoration: underline;">
                    @match.SectionTitle
                </h4>
                <p>@(HighlightKeywords(match.MatchedText))</p>
            </div>
        }
    </div>

    <!-- Right: PDF Viewer -->
    <div style="width: 60%; height: 100%;">
        <iframe id="pdfViewer" width="100%" height="100%" frameborder="0"></iframe>
    </div>
</div>

@code {
    private readonly string[] HighlightPalette = new[] { "#ffff00", "#ffb6c1", "#90ee90", "#add8e6", "#ffa07a" };
    private Dictionary<Keyword, string> keywordColors = new();
    private int? _pendingPage;

    protected override void OnInitialized()
    {
        var keywords = ResultStateService.Keywords;
        keywordColors = keywords.Select((k, i) => new { k, i }).ToDictionary(x => x.k, x => HighlightPalette[x.i % HighlightPalette.Length]);

        // Load first match by default after render
        if (ResultStateService.Matches.Count > 0)
        {
            var first = ResultStateService.Matches[0];
            _pendingPage = first.PageNumber;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_pendingPage.HasValue)
        {
            await LoadPdfAsync(_pendingPage.Value);
            _pendingPage = null;
        }
    }

    async Task LoadPdfAsync(int page)
    {
        var file = "/uploads/latest.pdf";
        var highlightParams = string.Join("&", keywordColors.Select(kvp => $"highlight={Uri.EscapeDataString(kvp.Key.Text)}&color={Uri.EscapeDataString(kvp.Value)}&partial={kvp.Key.AllowPartial.ToString().ToLower()}"));
        var viewerUrl = $"/pdfjs/index.html?file={file}&page={page}&{highlightParams}";
        await JS.InvokeVoidAsync("setIframeSrc", "pdfViewer", viewerUrl);
    }

    MarkupString HighlightKeywords(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return (MarkupString)text;
        var highlighted = text;
        foreach (var kvp in keywordColors)
        {
            var escaped = Regex.Escape(kvp.Key.Text);
            var pattern = kvp.Key.AllowPartial
                ? escaped
                : $@"(?<![\p{{L}}\p{{N}}]){escaped}(?![\p{{L}}\p{{N}}])";
            var regex = new Regex(pattern, RegexOptions.IgnoreCase);
            highlighted = regex.Replace(highlighted, m => $"<mark style='background-color: {kvp.Value};'>{m.Value}</mark>");
        }
        return (MarkupString)highlighted;
    }
}
